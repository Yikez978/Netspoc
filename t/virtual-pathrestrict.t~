#!/usr/bin/perl

use strict;
use Test::More;
use Test::Differences;
use lib 't';
use Test_Netspoc;

my ($title, $in, $out, @out, $head, $compiled);

############################################################
$title = 'Follow implicit pathrestriction at unmanaged virtual interface';
############################################################

# Doppelte ACL-Zeile für virtual IP vermeiden an
# - managed Gerät
# - mit virtueller IP zusätzlich an unmanged Gerät
# - mit Crosslink zu diesem unmanaged Gerät

$in = <<END;
network:M = { ip = 10.1.0.0/24;}

router:F = {
 managed;
 model = ASA;
 interface:M = {ip = 10.1.0.1; hardware = inside;}
 interface:A = {ip = 10.2.1.129; hardware = o1;}
 interface:B = {ip = 10.2.1.18; hardware = o2;}
}

network:A = {ip = 10.2.1.128/30;}

router:Z = {
 interface:A = {ip = 10.2.1.130;}
 interface:c = {ip = 10.2.6.166;}
 interface:K = {ip = 10.9.32.3; virtual = {ip = 10.9.32.1;}}
}

network:B = {ip = 10.2.1.16/30;} 

router:L = {
 managed;
 model = IOS;
 interface:B = {ip = 10.2.1.17; hardware = Ethernet1; no_in_acl;}
 interface:c  = {ip = 10.2.6.165; hardware = Ethernet2;}
 interface:K = {ip = 10.9.32.2; virtual = {ip = 10.9.32.1;} 
                hardware = Ethernet0;}
}

network:c  = {ip = 10.2.6.164/30;}
network:K = { ip = 10.9.32.0/21;}

pathrestriction:4 = interface:Z.A, interface:L.B;

service:x = {
 user = interface:L.K.virtual, interface:Z.K.virtual;
 permit src = network:M; dst = user; prt = icmp 17;
}
END

$out = <<END;
! [ ACL ]
access-list outside_in extended permit ip 10.1.7.0 255.255.255.0 host 193.1.1.2
access-list outside_in extended deny ip any any
access-group outside_in in interface outside
END

$head = (split /\n/, $out)[0];

eq_or_diff(get_block(compile($in), $head), $out, $title);
